#include "StateMachineLib.h"
#include <AsyncTaskLib.h>
#include <DHT.h> // Librería para DHT11

// State Alias
enum State
{
    Inicio = 0,
    Monitoreo_th = 1,
    Alerta = 2,
    Monitoreo_luz = 3,
    Alarma = 4
};

// Input Alias
enum Input
{
    H = 0,
    A = 1,
    L = 2,
    B = 3,
    Sign_Timeout = 4,   // Señal de timeout
    Unknown = 5
};

// Create new StateMachine
StateMachine stateMachine(5, 9);

// Stores last user input
Input input = Input::Unknown;

// ======= Definiciones de pines y DHT =======
const uint8_t DHT_PIN = 2;    // Pin digital para DHT11
const uint8_t LDR_PIN = A0;   // Pin analógico para LDR (A0 en Mega)
#define DHTTYPE DHT11
DHT dht(DHT_PIN, DHTTYPE);

// Tareas de timeout (originales)
AsyncTask timeoutInicio(5000, false, []() { input = Input::Sign_Timeout; });
AsyncTask timeoutMonThToLuz(7000, false, []() { input = Input::Sign_Timeout; });
AsyncTask timeoutAlertaToMonTh(4000, false, []() { input = Input::Sign_Timeout; });
AsyncTask timeoutMonLuzToTh(2000, false, []() { input = Input::Sign_Timeout; });
AsyncTask timeoutAlarmaToLuz(5000, false, []() { input = Input::Sign_Timeout; });

// ======= Nuevas tareas para lectura de sensores (solo usan AsyncTask) =======
// No arrancan automáticamente; las empezamos al entrar al estado y las paramos al salir
AsyncTask readDHTTask(2000, false, []() {
    // Leer DHT11 y mostrar temperatura y humedad
    float h = dht.readHumidity();
    float t = dht.readTemperature(); // Celsius
    if (isnan(h) || isnan(t)) {
        Serial.println("DHT11: lectura fallida");
    } else {
        Serial.print("DHT11 -> Temp (C): ");
        Serial.print(t);
        Serial.print("  Hum (%): ");
        Serial.println(h);
    }
});

AsyncTask readLDRTask(500, false, []() {
    // Leer LDR analógico (0..1023) y mostrar
    int val = analogRead(LDR_PIN);
    Serial.print("LDR -> Valor analogico: ");
    Serial.println(val); // 0..1023 en Mega
});

// Configuración de timeouts (y ahora arranca la tarea)
void setTimeout(AsyncTask& task, unsigned long interval) {
    task.SetIntervalMillis(interval);
    task.Reset();
    task.Start(); // <-- cambio mínimo ya aplicado antes; arranca la AsyncTask
}

// Setup the State Machine
void setupStateMachine()
{
    // Transiciones
    // Inicio -> Monitoreo_th (por timeout)
    stateMachine.AddTransition(Inicio, Monitoreo_th, []() { 
        return input == Input::Sign_Timeout; 
    });
    
    // Monitoreo_th -> Monitoreo_luz (por timeout)
    stateMachine.AddTransition(Monitoreo_th, Monitoreo_luz, []() { 
        return input == Input::Sign_Timeout; 
    });
    
    // Monitoreo_th -> Alerta (por tecla H)
    stateMachine.AddTransition(Monitoreo_th, Alerta, []() { 
        return input == Input::H; 
    });
    
    // Alerta -> Monitoreo_th (por timeout)
    stateMachine.AddTransition(Alerta, Monitoreo_th, []() { 
        return input == Input::Sign_Timeout; 
    });
    
    // Alerta -> Inicio (por tecla A)
    stateMachine.AddTransition(Alerta, Inicio, []() { 
        return input == Input::A; 
    });
    
    // Monitoreo_luz -> Monitoreo_th (por timeout)
    stateMachine.AddTransition(Monitoreo_luz, Monitoreo_th, []() { 
        return input == Input::Sign_Timeout; 
    });
    
    // Monitoreo_luz -> Alarma (por tecla L)
    stateMachine.AddTransition(Monitoreo_luz, Alarma, []() { 
        return input == Input::L; 
    });
    
    // Alarma -> Monitoreo_luz (por timeout)
    stateMachine.AddTransition(Alarma, Monitoreo_luz, []() { 
        return input == Input::Sign_Timeout; 
    });
    
    // Alarma -> Inicio (por tecla B)
    stateMachine.AddTransition(Alarma, Inicio, []() { 
        return input == Input::B; 
    });

    // Acciones de entrada a estados
    stateMachine.SetOnEntering(Inicio, []() {
        outputInicio();
        setTimeout(timeoutInicio, 5000); // Configura timeout 5s
    });
    
    stateMachine.SetOnEntering(Monitoreo_th, []() {
        outputMonitoreo_th();
        setTimeout(timeoutMonThToLuz, 7000); // Configura timeout 7s

        // Arrancar la tarea que lee DHT (cada 2000 ms)
        readDHTTask.SetIntervalMillis(2000);
        readDHTTask.Reset();
        readDHTTask.Start();
    });
    
    stateMachine.SetOnEntering(Alerta, []() {
        outputAlerta();
        setTimeout(timeoutAlertaToMonTh, 4000); // Configura timeout 4s
    });
    
    stateMachine.SetOnEntering(Monitoreo_luz, []() {
        outputMonitoreo_luz();
        setTimeout(timeoutMonLuzToTh, 2000); // Configura timeout 2s

        // Arrancar la tarea que lee LDR (cada 500 ms)
        readLDRTask.SetIntervalMillis(500);
        readLDRTask.Reset();
        readLDRTask.Start();
    });
    
    stateMachine.SetOnEntering(Alarma, []() {
        outputAlarma();
        setTimeout(timeoutAlarmaToLuz, 5000); // Configura timeout 5s
    });

    // Acciones de salida de estados
    stateMachine.SetOnLeaving(Inicio, []() { 
        Serial.println("Saliendo de Inicio"); 
        input = Input::Unknown;  // Resetear la señal
        timeoutInicio.Stop();
    });
    
    stateMachine.SetOnLeaving(Monitoreo_th, []() { 
        Serial.println("Saliendo de Monitoreo_th"); 
        input = Input::Unknown;  // Resetear la señal
        timeoutMonThToLuz.Stop();

        // Detener la tarea de lectura DHT al salir del estado
        readDHTTask.Stop();
    });
    
    stateMachine.SetOnLeaving(Alerta, []() { 
        Serial.println("Saliendo de Alerta"); 
        input = Input::Unknown;  // Resetear la señal
        timeoutAlertaToMonTh.Stop();
    });
    
    stateMachine.SetOnLeaving(Monitoreo_luz, []() { 
        Serial.println("Saliendo de Monitoreo_luz"); 
        input = Input::Unknown;  // Resetear la señal
        timeoutMonLuzToTh.Stop();

        // Detener la tarea de lectura LDR al salir del estado
        readLDRTask.Stop();
    });
    
    stateMachine.SetOnLeaving(Alarma, []() { 
        Serial.println("Saliendo de Alarma"); 
        input = Input::Unknown;  // Resetear la señal
        timeoutAlarmaToLuz.Stop();
    });
}

void setup() 
{
    Serial.begin(9600);
    Serial.println("Iniciando Maquina de Estados...");
    setupStateMachine();    
    Serial.println("Maquina de Estados Iniciada");

    // Inicializar DHT
    dht.begin();

    // Estado inicial
    stateMachine.SetState(Inicio, false, true);
}

void loop() 
{
    // Actualizar todas las tareas de timeout
    timeoutInicio.Update();
    timeoutMonThToLuz.Update();
    timeoutAlertaToMonTh.Update();
    timeoutMonLuzToTh.Update();
    timeoutAlarmaToLuz.Update();

    // Actualizar tareas de lectura de sensores
    readDHTTask.Update();
    readLDRTask.Update();

    // Leer entrada del usuario (solo si no hay señal activa)
    if(input == Input::Unknown) {
        input = static_cast<Input>(readInput());
    }

    // Actualizar maquina de estados
    stateMachine.Update();
}

// Función para leer entradas
int readInput()
{
    if (Serial.available())
    {
        char c = Serial.read();
        switch(c)
        {
            case 'H': return Input::H;
            case 'A': return Input::A;
            case 'L': return Input::L;
            case 'B': return Input::B;
        }
    }
    return Input::Unknown;
}

// Funciones de salida
void outputInicio() {
    Serial.println("\n--- ESTADO: Inicio ---");
    Serial.println("Transicion automatica a Monitoreo_th en 5s");
}

void outputMonitoreo_th() {
    Serial.println("\n--- ESTADO: Monitoreo_th ---");
    Serial.println("Transiciones:");
    Serial.println("  Automatico (7s) -> Monitoreo_luz");
    Serial.println("  Tecla 'H'       -> Alerta");
    Serial.println("Leyendo DHT11: se mostrará Temp y Hum mientras esté en este estado.");
}

void outputAlerta() {
    Serial.println("\n--- ESTADO: Alerta ---");
    Serial.println("Transiciones:");
    Serial.println("  Automatico (4s) -> Monitoreo_th");
    Serial.println("  Tecla 'A'       -> Inicio");
}

void outputMonitoreo_luz() {
    Serial.println("\n--- ESTADO: Monitoreo_luz ---");
    Serial.println("Transiciones:");
    Serial.println("  Automatico (2s) -> Monitoreo_th");
    Serial.println("  Tecla 'L'       -> Alarma");
    Serial.println("Leyendo LDR: se mostrará valor analogico (0..1023) mientras esté en este estado.");
}

void outputAlarma() {
    Serial.println("\n--- ESTADO: Alarma ---");
    Serial.println("Transiciones:");
    Serial.println("  Automatico (5s) -> Monitoreo_luz");
    Serial.println("  Tecla 'B'       -> Inicio");
}
